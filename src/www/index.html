<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Playlet</title>
</head>

<body ondrop="drop_handler(event);" ondragover="dragover_handler(event);">
  <h2>Playlet - Youtube Player for Roku</h2>
  <h4 id="app-version">Version: </h4>
  <h4>Invidious Instance: <a id="host" target="_blank">None</a></h4>

  <button onclick="PlayVideo()">Play Video</button>
  <label for="video-id">Video ID:</label>
  <input type="text" id="video-id" name="video-id" style="min-width:300px;">

  <h4 id="logged-in">Logged In: </h4>
  <button style="visibility: hidden" id="login-button" onclick="Login()">Login</button>
  <button style="visibility: hidden" id="logout-button">Logout</button>

  <h5>Instructions</h5>
  <ul>
    <li>Make sure you are logged in the Invidious instance before logging in on this page</li>
    <li>If this is your first time using this invidious Instance, you might want to create an account</li>
    <li>Once you are logged in to your current instance, click "Login" on this page, and authorize the token</li>
    <li>Once logged in, this page should show "Logged In: true"</li>
    <li>After login, the home page should refresh automatically. You should then be able to see your Subscription feed
      and Playlists, if you have any.</li>
  </ul>
  <p>
    This is a barebone page for now, stay tuned for a redesigned page!
  </p>
  <h5>Feedback is welcome over at: <a id="feedback-url" href="https://github.com/iBicha/playlet"
      target="_blank">https://github.com/iBicha/playlet</a></h5>

  <script>
    function RequestGet(url, cb) {
      const req = new XMLHttpRequest();
      req.addEventListener("load", function () {
        try {
          cb(null, JSON.parse(this.responseText));
        }
        catch (err) {
          cb(err)
        }
      });
      req.open("GET", url);
      req.send();
    }

    function Login() {
      if (!window.appState) {
        alert("Error with login, please refresh the page.")
      }
      window.location = window.appState.invidious.auth_url
    }

    function PlayVideo() {
      let v = document.getElementById('video-id').value
      if (isValidHttpUrl(v)) {
        v = getVideoId(v)
      }
      if (!v || v.length < 8) {
        alert("Please set video id")
        return
      }
      RequestGet(`/api/command/play?v=${v}`, function (err, response) {
        if (err) {
          alert(err)
        }
      })
    }

    function CreateGithubIssueUrl() {
      title = "[Feedback] Playlet"
      body = `### Feedback
_insert feedback here_

#### App Info
\`\`\`
${JSON.stringify(window.appState.app, null, 2)}
\`\`\`

#### Device Info
\`\`\`
${JSON.stringify(window.appState.device, null, 2)}
\`\`\``;
      return `https://github.com/iBicha/playlet/issues/new?title=${encodeURIComponent(title)}&body=${encodeURIComponent(body)}`
    }

    function isValidHttpUrl(string) {
      let url;
      try {
        url = new URL(string);
      } catch (_) {
        return false;
      }
      return url.protocol === "http:" || url.protocol === "https:";
    }

    function getVideoId(url) {
      // Short url
      if (url.startsWith("https://youtu.be/") || url.startsWith("http://youtu.be/")) {
        url = url.replace("https://youtu.be/", "").replace("http://youtu.be/", "")
        if (url.includes("?")) {
          url = url.substring(0, url.indexOf("?"))
        }
        return url
      }
      // regular url
      url = new URL(url)
      const urlSearchParams = new URLSearchParams(url.search);
      return urlSearchParams.get('v')
    }

    RequestGet("/api/state", function (err, response) {
      if (err) {
        alert(err)
        return
      }
      window.appState = response
      console.log(response)
      document.getElementById("app-version").innerText = `Version: ${response.app.version}`
      document.getElementById("logged-in").innerText = `Logged In: ${response.invidious.logged_in}`
      document.getElementById("host").innerText = response.invidious.host
      document.getElementById("host").href = response.invidious.host

      document.getElementById("login-button").style.visibility = response.invidious.logged_in ? "hidden" : "visible";
      // TODO: log out feature
      // document.getElementById("logout-button").style.visibility = response.invidious.logged_in ? "hidden" : "visible";

      document.getElementById("feedback-url").href = CreateGithubIssueUrl()
    })

    function drop_handler(event) {
      for (var i in event.dataTransfer.items) {
        let item = event.dataTransfer.items[i]
        if (item.kind = 'string' && item.getAsString) {
          item.getAsString((dataString) => {
            if (isValidHttpUrl(dataString)) {
              document.getElementById('video-id').value = dataString
            }
          });
        }
      }
      event.preventDefault();
    }
    function dragover_handler(event) {
      event.preventDefault();
    }
  </script>
</body>

</html>